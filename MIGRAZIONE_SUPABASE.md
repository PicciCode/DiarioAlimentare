# üîÑ Migrazione da SQLite a Supabase

Questa guida ti aiuter√† a migrare i tuoi dati esistenti da SQLite locale a Supabase cloud.

## üìã Prerequisiti

1. **Account Supabase**: Crea un account gratuito su [supabase.com](https://supabase.com)
2. **Progetto Supabase**: Crea un nuovo progetto nel dashboard
3. **Dati SQLite esistenti**: File `diarioalimentare.sqlite` nella directory principale

## üöÄ Passaggi per la Migrazione

### 1. Configura Supabase

1. **Crea il progetto**:
   - Vai su [supabase.com](https://supabase.com)
   - Clicca "New Project"
   - Scegli un nome (es. "diario-alimentare")
   - Imposta una password sicura
   - Seleziona una regione vicina

2. **Ottieni le credenziali**:
   - Nel dashboard, vai su **Settings** ‚Üí **API**
   - Copia l'**URL** del progetto
   - Copia la **anon public key**

3. **Configura le variabili d'ambiente**:
   ```bash
   cp env.example .env
   ```
   
   Modifica `.env` con i tuoi dati:
   ```env
   SUPABASE_URL=https://your-project-ref.supabase.co
   SUPABASE_API_KEY=your-anon-key-here
   ```

### 2. Crea la Tabella su Supabase

Vai nel **SQL Editor** di Supabase e esegui questo comando:

```sql
create table public."DiarioAlimentare" (
  id bigint generated by default as identity not null,
  data timestamp with time zone not null,
  pasto text null,
  alimento text null,
  quantit√† bigint null,
  unita_misura character varying null,
  carboidrati real null,
  glicemia_iniziale bigint null,
  glicemia_dop_2h bigint null,
  unita_insulina real null,
  note text null,
  dosi_correttive real null,
  tempo_dosi_correttive bigint null,
  constraint DiarioAlimentare_pkey primary key (id)
) TABLESPACE pg_default;
```

### 3. Migra i Dati (Opzionale)

Se hai dati esistenti in SQLite, puoi creare uno script di migrazione:

```python
# migrate_data.py
import sqlite3
import pandas as pd
from datetime import datetime
from src.database.diario_alimentare import DiarioAlimentareDB

def migrate_from_sqlite():
    """Migra i dati da SQLite a Supabase"""
    
    # Leggi i dati da SQLite
    conn = sqlite3.connect('diarioalimentare.sqlite')
    df = pd.read_sql_query("SELECT * FROM diario_alimentare", conn)
    conn.close()
    
    print(f"Trovati {len(df)} record da migrare...")
    
    # Migra ogni record
    for index, row in df.iterrows():
        try:
            # Converti la data se necessario
            data = datetime.fromisoformat(row['data']) if isinstance(row['data'], str) else row['data']
            
            # Crea il record su Supabase
            risultato = DiarioAlimentareDB.create_entry(
                data=data,
                pasto=row.get('pasto'),
                alimento=row.get('alimento'),
                quantita=row.get('quantita'),
                unita_misura=row.get('unita_misura'),
                carboidrati=row.get('carboidrati'),
                glicemia_iniziale=row.get('glicemia_iniziale'),
                glicemia_dop_2h=row.get('glicemia_dopo_2h'),
                unita_insulina=row.get('unita_insulina'),
                note=row.get('note'),
                dosi_correttive=row.get('dosi_correttive'),
                tempo_dosi_correttive=row.get('tempo_dose_correttiva')
            )
            
            if risultato["success"]:
                print(f"‚úÖ Migrato record {index + 1}/{len(df)}")
            else:
                print(f"‚ùå Errore record {index + 1}: {risultato['error']}")
                
        except Exception as e:
            print(f"‚ùå Errore record {index + 1}: {e}")
    
    print("üéâ Migrazione completata!")

if __name__ == "__main__":
    migrate_from_sqlite()
```

### 4. Testa la Nuova Configurazione

1. **Avvia l'applicazione**:
   ```bash
   cd src
   streamlit run main.py
   ```

2. **Verifica la connessione**:
   - L'app dovrebbe connettersi a Supabase
   - Prova ad aggiungere un record di test
   - Verifica che appaia nella sezione "Visualizza Dati"

3. **Controlla su Supabase**:
   - Vai nel dashboard Supabase
   - Sezione **Table Editor**
   - Dovresti vedere la tabella `DiarioAlimentare` con i tuoi dati

## ‚úÖ Vantaggi della Migrazione

### üåê Accesso Multi-dispositivo
- I tuoi dati sono accessibili da qualsiasi dispositivo
- Sincronizzazione automatica tra dispositivi

### üîí Sicurezza e Backup
- Backup automatici gestiti da Supabase
- Connessioni crittografate
- Gestione professionale dell'infrastruttura

### üìä Funzionalit√† Avanzate
- Dashboard web per visualizzare i dati
- API REST automatica
- Possibilit√† di integrazioni future

### üöÄ Scalabilit√†
- Il database pu√≤ crescere senza limiti
- Performance ottimizzate
- Nessuna manutenzione richiesta

## üîß Risoluzione Problemi

### Errore di Connessione
```
Errore: SUPABASE_URL e SUPABASE_API_KEY devono essere impostati
```
**Soluzione**: Verifica che il file `.env` sia configurato correttamente.

### Tabella Non Trovata
```
Errore: relation "DiarioAlimentare" does not exist
```
**Soluzione**: Esegui il comando SQL per creare la tabella nel dashboard Supabase.

### Errore di Autenticazione
```
Errore: Invalid API key
```
**Soluzione**: Verifica che la chiave API sia corretta e che sia la "anon public key".

## üìù Note Importanti

1. **Backup**: Prima di migrare, fai un backup del tuo file SQLite
2. **Test**: Testa sempre la migrazione con pochi record prima di migrare tutto
3. **Credenziali**: Non condividere mai le tue credenziali Supabase
4. **Limiti**: L'account gratuito ha limiti di storage e richieste (generalmente sufficienti per uso personale)

## üÜò Supporto

Se incontri problemi durante la migrazione:

1. Controlla la documentazione di Supabase
2. Verifica i log dell'applicazione Streamlit
3. Testa la connessione con un record semplice
4. Assicurati che le variabili d'ambiente siano corrette

La migrazione a Supabase ti dar√† accesso a un database cloud professionale con tutte le funzionalit√† moderne per la gestione dei dati! 